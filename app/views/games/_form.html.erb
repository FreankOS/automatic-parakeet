<%= form_with model: @game, local: true, multipart: true, class: "space-y-6" do |form| %>
  <% if @game.errors.any? %>
    <div class="bg-red-900/20 border border-red-600 text-red-400 px-4 py-3 rounded-lg">
      <h4 class="font-medium mb-2"><%= pluralize(@game.errors.count, "error") %> prohibited this game from being saved:</h4>
      <ul class="list-disc list-inside space-y-1">
        <% @game.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <!-- Game Name -->
  <div>
    <%= form.label :name, class: "block text-sm font-medium text-white mb-2" %>
    <%= form.text_field :name,
        class: "w-full px-3 py-2 bg-[#0c1925] border border-[#393a3a] rounded-lg focus:ring-2 focus:ring-[#cc6600] focus:border-[#cc6600] text-white placeholder-gray-400",
        placeholder: "Enter your game's name" %>
  </div>

  <!-- Description -->
  <div>
    <%= form.label :description, class: "block text-sm font-medium text-white mb-2" %>
    <%= form.text_area :description,
        rows: 6,
        class: "w-full px-3 py-2 bg-[#0c1925] border border-[#393a3a] rounded-lg focus:ring-2 focus:ring-[#cc6600] focus:border-[#cc6600] text-white placeholder-gray-400",
        placeholder: "Describe your game, its features, gameplay, and what makes it special..." %>
  </div>

  <!-- Genre and Tool -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div>
      <%= form.label :genre_id, "Genre", class: "block text-sm font-medium text-white mb-2" %>
      <%= form.select :genre_id,
          options_from_collection_for_select(@genres, :id, :translated_name, @game.genre_id),
          { prompt: "Select a genre" },
          { class: "w-full px-3 py-2 bg-[#0c1925] border border-[#393a3a] rounded-lg focus:ring-2 focus:ring-[#cc6600] focus:border-[#cc6600] text-white" } %>
    </div>

    <div>
      <%= form.label :tool_id, "Development Tool", class: "block text-sm font-medium text-white mb-2" %>
      <%= form.select :tool_id,
          options_from_collection_for_select(@tools, :id, :name, @game.tool_id),
          { prompt: "Select development tool" },
          { class: "w-full px-3 py-2 bg-[#0c1925] border border-[#393a3a] rounded-lg focus:ring-2 focus:ring-[#cc6600] focus:border-[#cc6600] text-white" } %>
    </div>
  </div>

  <!-- Release Type and Adult Content -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div>
      <%= form.label :release_type, class: "block text-sm font-medium text-white mb-2" %>
      <%= form.select :release_type,
          options_for_select([
            ["Complete Game", "complete"],
            ["Demo", "demo"],
            ["Mini Game", "minigame"]
          ], @game.release_type),
          { prompt: "Select release type" },
          { class: "w-full px-3 py-2 bg-[#0c1925] border border-[#393a3a] rounded-lg focus:ring-2 focus:ring-[#cc6600] focus:border-[#cc6600] text-white" } %>
    </div>

    <div class="flex items-center pt-8">
      <%= form.check_box :adult_content,
          class: "h-4 w-4 text-[#cc6600] focus:ring-[#cc6600] border-[#393a3a] bg-[#0c1925] rounded" %>
      <%= form.label :adult_content, t('forms.game.adult_content'), class: "ml-2 text-sm font-medium text-white" %>
    </div>
  </div>

  <!-- Languages -->
  <div class="mb-6" data-controller="language-selector">
    <div class="flex items-center justify-between mb-3">
      <label class="block text-sm font-medium text-white">
        <%= t('forms.game.languages') %>
        <span class="text-gray-400 text-xs block font-normal"><%= t('forms.game.languages_help') %></span>
      </label>
      <div class="flex space-x-2">
        <button type="button" 
                data-action="click->language-selector#selectAll"
                class="px-3 py-1 text-xs bg-[#cc6600]/20 text-[#cc6600] hover:bg-[#cc6600]/30 rounded-md transition-colors">
          <%= t('forms.game.select_all_languages') %>
        </button>
        <button type="button" 
                data-action="click->language-selector#selectNone"
                class="px-3 py-1 text-xs bg-[#0c1925] text-gray-300 hover:bg-[#393a3a] rounded-md transition-colors border border-[#393a3a]">
          <%= t('forms.game.select_no_languages') %>
        </button>
      </div>
    </div>
    <div class="grid grid-cols-3 gap-3 max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-4" 
         data-language-selector-target="container">
      <% I18n.available_locales.each do |locale| %>
        <% existing_language = @game.game_languages.find { |gl| gl.language_code == locale.to_s } %>
        <div class="flex items-center">
          <%= form.fields_for :game_languages, existing_language || @game.game_languages.build(language_code: locale.to_s) do |language_form| %>
            <%= language_form.hidden_field :language_code %>
            <label class="flex items-center cursor-pointer w-full">
              <%= language_form.check_box :_destroy, 
                  { checked: existing_language.blank?, class: "rounded border-[#393a3a] bg-[#0c1925] text-[#cc6600] shadow-sm focus:border-[#cc6600] focus:ring focus:ring-[#cc6600] focus:ring-opacity-50" },
                  "1", "0" %>
              <div class="ml-2 flex-1">
                <div class="text-xs font-mono bg-[#0c1925] px-2 py-1 rounded mb-1 text-center border border-[#393a3a] text-gray-300">
                  <%= locale.to_s.upcase %>
                </div>
                <div class="text-xs text-gray-300 text-center">
                  <%= t("languages.#{locale}") %>
                </div>
              </div>
            </label>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Media Uploads -->
  <div>
    <h3 class="text-lg font-medium text-white mb-4">Media</h3>

    <!-- Existing Media -->
    <div id="existing-media" 
         class="mb-6"
         data-controller="media-fields"
         data-media-fields-media-index-value="<%= @game.media.size %>"
         data-action="media-fields:mediaCountChanged->drag-drop-upload#mediaCountChanged">
      <%= form.fields_for :media do |media_form| %>
        <%= render 'media_fields', form: media_form %>
      <% end %>
    </div>

    <!-- Drag and Drop Upload Zones -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <!-- Screenshots Drop Zone -->
      <div data-controller="drag-drop-upload"
           data-drag-drop-upload-media-type-value="screenshot"
           data-drag-drop-upload-max-files-value="6"
           data-drag-drop-upload-accept-value="image/jpeg,image/jpg,image/png,image/gif,image/webp"
           data-drag-drop-upload-current-count-value="<%= @game.screenshots.count %>">

        <div class="flex items-center justify-between mb-3">
          <h4 class="text-sm font-medium text-white">Screenshots</h4>
          <span data-drag-drop-upload-target="counter" class="text-xs text-gray-400"></span>
        </div>

        <div data-drag-drop-upload-target="dropZone"
             class="relative border-2 border-dashed border-[#cc6600] rounded-lg p-6 text-center hover:border-[#b85c00] transition-colors cursor-pointer bg-[#cc6600]/10 hover:bg-[#cc6600]/20">

          <input type="file"
                 data-drag-drop-upload-target="fileInput"
                 data-action="change->drag-drop-upload#fileInputChanged"
          multiple
          accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
          class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">

          <div class="space-y-2">
            <svg class="mx-auto h-12 w-12 text-[#cc6600]" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image-up-icon lucide-image-up"><path d="M10.3 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10l-3.1-3.1a2 2 0 0 0-2.814.014L6 21"/><path d="m14 19.5 3-3 3 3"/><path d="M17 22v-5.5"/><circle cx="9" cy="9" r="2"/></svg>
            <div class="text-sm text-[#cc6600]">
              <span class="font-medium">Click to upload</span> or drag and drop
            </div>
            <p class="text-xs text-[#cc6600]">PNG, JPG, GIF, WebP up to 10MB</p>
            <p class="text-xs text-[#cc6600]">Maximum 6 screenshots</p>
          </div>
        </div>
      </div>

      <!-- Videos Drop Zone -->
      <div data-controller="drag-drop-upload"
           data-drag-drop-upload-media-type-value="video"
           data-drag-drop-upload-max-files-value="3"
           data-drag-drop-upload-accept-value="video/mp4,video/webm,video/ogg,video/avi,video/mov"
           data-drag-drop-upload-current-count-value="<%= @game.videos.count %>">

        <div class="flex items-center justify-between mb-3">
          <h4 class="text-sm font-medium text-white">Videos</h4>
          <span data-drag-drop-upload-target="counter" class="text-xs text-gray-400"></span>
        </div>

        <div data-drag-drop-upload-target="dropZone"
             class="relative border-2 border-dashed border-[#cc6600] rounded-lg p-6 text-center hover:border-[#b85c00] transition-colors cursor-pointer bg-[#cc6600]/10 hover:bg-[#cc6600]/20">

          <input type="file"
                 data-drag-drop-upload-target="fileInput"
                 data-action="change->drag-drop-upload#fileInputChanged"
          multiple
          accept="video/mp4,video/webm,video/ogg,video/avi,video/mov"
          class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">

          <div class="space-y-2">
            <svg class="mx-auto h-12 w-12 text-[#cc6600]" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-video-icon lucide-video"><path d="m16 13 5.223 3.482a .5.5 0 0 0 .777-.416V7.87a.5.5 0 0 0-.752-.432L16 10.5"/><rect x="2" y="6" width="14" height="12" rx="2"/></svg>
            <div class="text-sm text-[#cc6600]">
              <span class="font-medium">Click to upload</span> or drag and drop
            </div>
            <p class="text-xs text-[#cc6600]">MP4, WebM, OGG, AVI, MOV up to 100MB</p>
            <p class="text-xs text-[#cc6600]">Maximum 3 videos</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Legacy Add Buttons (fallback) -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <button type="button"
              onclick="addMediaField('screenshot')"
              class="inline-flex items-center justify-center px-4 py-2 border border-[#cc6600] rounded-lg text-sm font-medium text-[#cc6600] bg-[#162737] hover:bg-[#0c1925] focus:outline-none focus:ring-2 focus:ring-[#cc6600] transition-colors">
        <svg class="h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-icon lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
        Add Screenshot Manually
      </button>

      <button type="button"
              onclick="addMediaField('video')"
              class="inline-flex items-center justify-center px-4 py-2 border border-[#cc6600] rounded-lg text-sm font-medium text-[#cc6600] bg-[#162737] hover:bg-[#0c1925] focus:outline-none focus:ring-2 focus:ring-[#cc6600] transition-colors">
        <svg class="h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-icon lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
        Add Video Manually
      </button>
    </div>

    <!-- Cover Image Selection -->
    <div class="mb-6" 
         id="cover-image-section"
         data-controller="cover-image"
         data-cover-image-selected-id-value="<%= @game.cover_image_id %>">
      <h4 class="text-lg font-medium text-white mb-3">Cover Image</h4>
      <p class="text-sm text-gray-300 mb-4">Select a screenshot to use as your game's main cover image. This will be displayed in game listings and previews.</p>

      <div id="cover-image-options" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
        <!-- Existing screenshots will be populated here -->
        <% @game.screenshots.each do |screenshot| %>
          <div class="cover-option relative cursor-pointer border-2 rounded-lg overflow-hidden transition-all duration-200 <%= @game.cover_image_id == screenshot.id ? 'border-[#cc6600] ring-2 ring-[#cc6600]/20' : 'border-[#393a3a] hover:border-[#cc6600]' %>"
               data-cover-image-target="option"
               data-screenshot-id="<%= screenshot.id %>"
               data-action="click->cover-image#select">
            <% if screenshot.file.attached? %>
              <%= image_tag screenshot.file, class: "w-full h-24 object-cover" %>
            <% else %>
              <div class="w-full h-24 bg-[#0c1925] flex items-center justify-center border border-[#393a3a] rounded">
                <span class="text-gray-400 text-xs">No preview</span>
              </div>
            <% end %>

            <div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-20 transition-all duration-200 flex items-center justify-center">
              <div class="cover-selected-indicator <%= @game.cover_image_id == screenshot.id ? 'opacity-100' : 'opacity-0' %> transition-opacity duration-200">
                <div class="bg-[#cc6600] text-white rounded-full p-1">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                </div>
              </div>
            </div>

            <div class="absolute bottom-1 left-1 right-1">
              <div class="bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded text-center truncate">
                <%= screenshot.display_title %>
              </div>
            </div>
          </div>
        <% end %>

        <!-- No screenshots message -->
        <div id="no-screenshots-message" 
             class="<%= @game.screenshots.any? ? 'hidden' : '' %> col-span-full text-center py-8 text-gray-400"
             data-cover-image-target="noScreenshotsMessage">
          <svg class="mx-auto h-12 w-12 text-gray-400 mb-3" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image-icon lucide-image"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
          <p class="text-sm">Upload screenshots above to select a cover image</p>
        </div>
      </div>

      <!-- Hidden field for cover image ID -->
      <%= form.hidden_field :cover_image_id, 
          id: "cover_image_id_field",
          data: { cover_image_target: "hiddenField" } %>

      <!-- Clear selection button -->
      <div class="mt-3 <%= @game.cover_image_id.present? ? '' : 'hidden' %>" 
           id="clear-cover-button"
           data-cover-image-target="clearButton">
        <button type="button"
                data-action="click->cover-image#clear"
                class="text-sm text-red-400 hover:text-red-300 font-medium">
          Clear cover image selection
        </button>
      </div>
    </div>

    <!-- Media Upload Guidelines -->
    <div class="bg-[#cc6600]/10 border border-[#cc6600] rounded-lg p-4">
      <h4 class="text-sm font-medium text-[#cc6600] mb-2">Media Guidelines</h4>
      <ul class="text-sm text-[#cc6600] space-y-1 list-disc list-inside">
        <li>Screenshots should showcase your game's best features and gameplay</li>
        <li>Videos can include gameplay footage, trailers, or tutorials</li>
        <li>Keep file sizes reasonable for faster loading (Screenshots: 10MB max, Videos: 100MB max)</li>
        <li>Media will be displayed in the order you upload them</li>
        <li><strong>The first screenshot you upload will be automatically set as the cover image</strong></li>
      </ul>
    </div>
  </div>

  <!-- Download Links -->
  <div data-controller="download-links"
       data-download-links-link-index-value="<%= @game.download_links.size %>">
    <h3 class="text-lg font-medium text-white mb-4">Download Links</h3>
    <div id="download-links" data-download-links-target="container">
      <%= form.fields_for :download_links do |link_form| %>
        <%= render 'download_link_fields', form: link_form, platforms: @platforms %>
      <% end %>
    </div>

    <button type="button"
            data-action="click->download-links#addLink"
            class="mt-4 inline-flex items-center px-4 py-2 border border-[#393a3a] rounded-lg text-sm font-medium text-gray-300 bg-[#162737] hover:bg-[#0c1925] focus:outline-none focus:ring-2 focus:ring-[#cc6600]">
      <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
      </svg>
      Add Download Link
    </button>
  </div>

  <!-- Submit Buttons -->
  <div class="flex items-center justify-between pt-6 border-t border-[#393a3a]">
    <%= link_to cancel_path,
        class: "px-4 py-2 text-gray-300 bg-[#393a3a] hover:bg-[#0c1925] rounded-lg font-medium transition-colors" do %>
      Cancel
    <% end %>

    <%= form.submit submit_text,
        class: "px-6 py-2 bg-[#cc6600] hover:bg-[#b85c00] text-white rounded-lg font-medium transition-all duration-200 shadow-sm" %>
  </div>
<% end %>

<template id="media-field-template">
  <div class="media-field border border-gray-200 rounded-lg p-4 mb-4">
    <input type="hidden" name="game[media_attributes][MEDIA_INDEX_PLACEHOLDER][media_type]" value="MEDIA_TYPE_PLACEHOLDER">

    <div class="flex items-start justify-between mb-4">
      <div class="flex-1">
        <h4 class="text-sm font-medium text-white mb-2">
          <span class="media-type-label">MEDIA_TYPE_LABEL_PLACEHOLDER</span>
          <span class="text-xs text-gray-400">(New)</span>
        </h4>
      </div>

      <button type="button"
              onclick="removeMediaField(this)"
              class="text-red-400 hover:text-red-300 text-sm font-medium ml-4">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
        </svg>
      </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <!-- File Upload -->
      <div>
        <label class="block text-sm font-medium text-white mb-2">File</label>
        <input type="file"
               name="game[media_attributes][MEDIA_INDEX_PLACEHOLDER][file]"
               accept="ACCEPT_PLACEHOLDER"
               class="FILE_CLASS_PLACEHOLDER">
      </div>

      <!-- Title -->
      <div>
        <label class="block text-sm font-medium text-white mb-2">Title (Optional)</label>
        <input type="text"
               name="game[media_attributes][MEDIA_INDEX_PLACEHOLDER][title]"
               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
               placeholder="e.g., Main Menu, Gameplay Screenshot">
      </div>
    </div>

    <!-- Description -->
    <div class="mb-4">
      <label class="block text-sm font-medium text-white mb-2">Description (Optional)</label>
      <textarea name="game[media_attributes][MEDIA_INDEX_PLACEHOLDER][description]"
                rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="Brief description of this media..."></textarea>
    </div>

    <!-- Position -->
    <div>
      <label class="block text-sm font-medium text-white mb-2">Display Order</label>
      <input type="number"
             name="game[media_attributes][MEDIA_INDEX_PLACEHOLDER][position]"
             class="w-20 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
             min="0"
             placeholder="0">
      <span class="text-xs text-gray-400 ml-2">Lower numbers appear first</span>
    </div>
  </div>
</template>

<template id="download-link-template" data-download-links-target="template">
  <div class="download-link-fields border border-[#393a3a] rounded-lg p-4 mb-4 bg-[#162737]">
    <input type="hidden" name="game[download_links_attributes][INDEX_PLACEHOLDER][id]" value="">

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <div>
        <label class="block text-sm font-medium text-white mb-2">Label</label>
        <input type="text"
               name="game[download_links_attributes][INDEX_PLACEHOLDER][label]"
               class="w-full px-3 py-2 bg-[#0c1925] border border-[#393a3a] rounded-lg focus:ring-2 focus:ring-[#cc6600] focus:border-[#cc6600] text-white placeholder-gray-400"
               placeholder="e.g., Windows Download, Mac Version">
      </div>

      <div>
        <label class="block text-sm font-medium text-white mb-2">URL</label>
        <input type="url"
               name="game[download_links_attributes][INDEX_PLACEHOLDER][url]"
               class="w-full px-3 py-2 bg-[#0c1925] border border-[#393a3a] rounded-lg focus:ring-2 focus:ring-[#cc6600] focus:border-[#cc6600] text-white placeholder-gray-400"
               placeholder="https://...">
      </div>
    </div>

    <div class="mb-4">
      <label class="block text-sm font-medium text-white mb-2">Platforms</label>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
        <% @platforms.each do |platform| %>
          <label class="flex items-center">
            <input type="checkbox"
                   name="game[download_links_attributes][INDEX_PLACEHOLDER][platform_ids][]"
                   value="<%= platform.id %>"
                   class="h-4 w-4 text-[#cc6600] focus:ring-[#cc6600] border-[#393a3a] bg-[#0c1925] rounded">
            <span class="ml-2 text-sm text-white"><%= platform.name %></span>
          </label>
        <% end %>
      </div>
    </div>

    <button type="button"
            data-action="click->download-links#removeLink"
            class="text-red-400 hover:text-red-300 text-sm font-medium">
      Remove Download Link
    </button>
  </div>
</template>