<%= form_with model: @game, local: true, multipart: true, class: "space-y-6" do |form| %>
  <% if @game.errors.any? %>
    <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
      <h4 class="font-medium mb-2"><%= pluralize(@game.errors.count, "error") %> prohibited this game from being saved:</h4>
      <ul class="list-disc list-inside space-y-1">
        <% @game.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <!-- Game Name -->
  <div>
    <%= form.label :name, class: "block text-sm font-medium text-gray-700 mb-2" %>
    <%= form.text_field :name,
        class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",
        placeholder: "Enter your game's name" %>
  </div>

  <!-- Description -->
  <div>
    <%= form.label :description, class: "block text-sm font-medium text-gray-700 mb-2" %>
    <%= form.text_area :description,
        rows: 6,
        class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",
        placeholder: "Describe your game, its features, gameplay, and what makes it special..." %>
  </div>

  <!-- Genre and Tool -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div>
      <%= form.label :genre_id, "Genre", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.select :genre_id,
          options_from_collection_for_select(@genres, :id, :translated_name, @game.genre_id),
          { prompt: "Select a genre" },
          { class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" } %>
    </div>

    <div>
      <%= form.label :tool_id, "Development Tool", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.select :tool_id,
          options_from_collection_for_select(@tools, :id, :name, @game.tool_id),
          { prompt: "Select development tool" },
          { class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" } %>
    </div>
  </div>

  <!-- Release Type and Adult Content -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div>
      <%= form.label :release_type, class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.select :release_type,
          options_for_select([
            ["Complete Game", "complete"],
            ["Demo", "demo"],
            ["Mini Game", "minigame"]
          ], @game.release_type),
          { prompt: "Select release type" },
          { class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" } %>
    </div>

    <div class="flex items-center pt-8">
      <%= form.check_box :adult_content,
          class: "h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" %>
      <%= form.label :adult_content, "Adult Content", class: "ml-2 text-sm font-medium text-gray-700" %>
    </div>
  </div>

  <!-- Media Uploads -->
  <div>
    <h3 class="text-lg font-medium text-gray-900 mb-4">Media</h3>
    
    <!-- Existing Media -->
    <div id="existing-media" class="mb-6">
      <%= form.fields_for :media do |media_form| %>
        <%= render 'media_fields', form: media_form %>
      <% end %>
    </div>

    <!-- Drag and Drop Upload Zones -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <!-- Screenshots Drop Zone -->
      <div data-controller="drag-drop-upload"
           data-drag-drop-upload-media-type-value="screenshot"
           data-drag-drop-upload-max-files-value="6"
           data-drag-drop-upload-accept-value="image/jpeg,image/jpg,image/png,image/gif,image/webp"
           data-drag-drop-upload-current-count-value="<%= @game.screenshots.count %>">
        
        <div class="flex items-center justify-between mb-3">
          <h4 class="text-sm font-medium text-gray-900">Screenshots</h4>
          <span data-drag-drop-upload-target="counter" class="text-xs text-gray-500"></span>
        </div>
        
        <div data-drag-drop-upload-target="dropZone"
             class="relative border-2 border-dashed border-blue-300 rounded-lg p-6 text-center hover:border-blue-400 transition-colors cursor-pointer bg-blue-50 hover:bg-blue-100">
          
          <input type="file"
                 data-drag-drop-upload-target="fileInput"
                 data-action="change->drag-drop-upload#fileInputChanged"
                 multiple
                 accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
                 class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
          
          <div class="space-y-2">
            <svg class="mx-auto h-12 w-12 text-blue-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
              <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <div class="text-sm text-blue-600">
              <span class="font-medium">Click to upload</span> or drag and drop
            </div>
            <p class="text-xs text-blue-500">PNG, JPG, GIF, WebP up to 10MB</p>
            <p class="text-xs text-blue-500">Maximum 6 screenshots</p>
          </div>
        </div>
      </div>

      <!-- Videos Drop Zone -->
      <div data-controller="drag-drop-upload"
           data-drag-drop-upload-media-type-value="video"
           data-drag-drop-upload-max-files-value="3"
           data-drag-drop-upload-accept-value="video/mp4,video/webm,video/ogg,video/avi,video/mov"
           data-drag-drop-upload-current-count-value="<%= @game.videos.count %>">
        
        <div class="flex items-center justify-between mb-3">
          <h4 class="text-sm font-medium text-gray-900">Videos</h4>
          <span data-drag-drop-upload-target="counter" class="text-xs text-gray-500"></span>
        </div>
        
        <div data-drag-drop-upload-target="dropZone"
             class="relative border-2 border-dashed border-purple-300 rounded-lg p-6 text-center hover:border-purple-400 transition-colors cursor-pointer bg-purple-50 hover:bg-purple-100">
          
          <input type="file"
                 data-drag-drop-upload-target="fileInput"
                 data-action="change->drag-drop-upload#fileInputChanged"
                 multiple
                 accept="video/mp4,video/webm,video/ogg,video/avi,video/mov"
                 class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
          
          <div class="space-y-2">
            <svg class="mx-auto h-12 w-12 text-purple-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
              <path d="M15.75 10.5l4.72-4.72a.75.75 0 011.28.53v26.38a.75.75 0 01-1.28.53l-4.72-4.72M4.5 18v12a3 3 0 003 3h9.75m-12.75-18h12.75m0 0V9a3 3 0 013-3h9.75a3 3 0 013 3v30a3 3 0 01-3 3H16.5a3 3 0 01-3-3V18z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <div class="text-sm text-purple-600">
              <span class="font-medium">Click to upload</span> or drag and drop
            </div>
            <p class="text-xs text-purple-500">MP4, WebM, OGG, AVI, MOV up to 100MB</p>
            <p class="text-xs text-purple-500">Maximum 3 videos</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Legacy Add Buttons (fallback) -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <button type="button"
              onclick="addMediaField('screenshot')"
              class="inline-flex items-center justify-center px-4 py-2 border border-blue-300 rounded-lg text-sm font-medium text-blue-700 bg-white hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
        <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
        </svg>
        Add Screenshot Manually
      </button>

      <button type="button"
              onclick="addMediaField('video')"
              class="inline-flex items-center justify-center px-4 py-2 border border-purple-300 rounded-lg text-sm font-medium text-purple-700 bg-white hover:bg-purple-50 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-colors">
        <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
        </svg>
        Add Video Manually
      </button>
    </div>

    <!-- Cover Image Selection -->
    <div class="mb-6" id="cover-image-section">
      <h4 class="text-lg font-medium text-gray-900 mb-3">Cover Image</h4>
      <p class="text-sm text-gray-600 mb-4">Select a screenshot to use as your game's main cover image. This will be displayed in game listings and previews.</p>
      
      <div id="cover-image-options" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
        <!-- Existing screenshots will be populated here -->
        <% @game.screenshots.each do |screenshot| %>
          <div class="cover-option relative cursor-pointer border-2 rounded-lg overflow-hidden transition-all duration-200 <%= @game.cover_image_id == screenshot.id ? 'border-blue-500 ring-2 ring-blue-200' : 'border-gray-200 hover:border-blue-300' %>"
               onclick="selectCoverImage(<%= screenshot.id %>, this)">
            <% if screenshot.file.attached? %>
              <%= image_tag screenshot.file, class: "w-full h-24 object-cover" %>
            <% else %>
              <div class="w-full h-24 bg-gray-100 flex items-center justify-center">
                <span class="text-gray-400 text-xs">No preview</span>
              </div>
            <% end %>
            
            <div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-20 transition-all duration-200 flex items-center justify-center">
              <div class="cover-selected-indicator <%= @game.cover_image_id == screenshot.id ? 'opacity-100' : 'opacity-0' %> transition-opacity duration-200">
                <div class="bg-blue-500 text-white rounded-full p-1">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                </div>
              </div>
            </div>
            
            <div class="absolute bottom-1 left-1 right-1">
              <div class="bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded text-center truncate">
                <%= screenshot.display_title %>
              </div>
            </div>
          </div>
        <% end %>
        
        <!-- No screenshots message -->
        <div id="no-screenshots-message" class="<%= @game.screenshots.any? ? 'hidden' : '' %> col-span-full text-center py-8 text-gray-500">
          <svg class="mx-auto h-12 w-12 text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
          </svg>
          <p class="text-sm">Upload screenshots above to select a cover image</p>
        </div>
      </div>
      
      <!-- Hidden field for cover image ID -->
      <%= form.hidden_field :cover_image_id, id: "cover_image_id_field" %>
      
      <!-- Clear selection button -->
      <div class="mt-3 <%= @game.cover_image_id.present? ? '' : 'hidden' %>" id="clear-cover-button">
        <button type="button" 
                onclick="clearCoverImage()"
                class="text-sm text-red-600 hover:text-red-800 font-medium">
          Clear cover image selection
        </button>
      </div>
    </div>

    <!-- Media Upload Guidelines -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
      <h4 class="text-sm font-medium text-blue-900 mb-2">Media Guidelines</h4>
      <ul class="text-sm text-blue-800 space-y-1 list-disc list-inside">
        <li>Screenshots should showcase your game's best features and gameplay</li>
        <li>Videos can include gameplay footage, trailers, or tutorials</li>
        <li>Keep file sizes reasonable for faster loading (Screenshots: 10MB max, Videos: 100MB max)</li>
        <li>Media will be displayed in the order you upload them</li>
        <li><strong>The first screenshot you upload will be automatically set as the cover image</strong></li>
      </ul>
    </div>
  </div>

  <!-- Download Links -->
  <div>
    <h3 class="text-lg font-medium text-gray-900 mb-4">Download Links</h3>
    <div id="download-links">
      <%= form.fields_for :download_links do |link_form| %>
        <%= render 'download_link_fields', form: link_form, platforms: @platforms %>
      <% end %>
    </div>

    <button type="button"
            onclick="addDownloadLink()"
            class="mt-4 inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
      <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
      </svg>
      Add Download Link
    </button>
  </div>

  <!-- Submit Buttons -->
  <div class="flex items-center justify-between pt-6 border-t border-gray-200">
    <%= link_to cancel_path,
        class: "px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium transition-colors" do %>
      Cancel
    <% end %>

    <%= form.submit submit_text,
        class: "px-6 py-2 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white rounded-lg font-medium transition-all duration-200 shadow-sm" %>
  </div>
<% end %>

<template id="media-field-template">
  <div class="media-field border border-gray-200 rounded-lg p-4 mb-4">
    <input type="hidden" name="game[media_attributes][MEDIA_INDEX_PLACEHOLDER][media_type]" value="MEDIA_TYPE_PLACEHOLDER">
    
    <div class="flex items-start justify-between mb-4">
      <div class="flex-1">
        <h4 class="text-sm font-medium text-gray-900 mb-2">
          <span class="media-type-label">MEDIA_TYPE_LABEL_PLACEHOLDER</span>
          <span class="text-xs text-gray-500">(New)</span>
        </h4>
      </div>
      
      <button type="button" 
              onclick="removeMediaField(this)"
              class="text-red-600 hover:text-red-800 text-sm font-medium ml-4">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
        </svg>
      </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <!-- File Upload -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">File</label>
        <input type="file"
               name="game[media_attributes][MEDIA_INDEX_PLACEHOLDER][file]"
               accept="ACCEPT_PLACEHOLDER"
               class="FILE_CLASS_PLACEHOLDER">
      </div>

      <!-- Title -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Title (Optional)</label>
        <input type="text"
               name="game[media_attributes][MEDIA_INDEX_PLACEHOLDER][title]"
               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
               placeholder="e.g., Main Menu, Gameplay Screenshot">
      </div>
    </div>

    <!-- Description -->
    <div class="mb-4">
      <label class="block text-sm font-medium text-gray-700 mb-2">Description (Optional)</label>
      <textarea name="game[media_attributes][MEDIA_INDEX_PLACEHOLDER][description]"
                rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="Brief description of this media..."></textarea>
    </div>

    <!-- Position -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Display Order</label>
      <input type="number"
             name="game[media_attributes][MEDIA_INDEX_PLACEHOLDER][position]"
             class="w-20 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
             min="0"
             placeholder="0">
      <span class="text-xs text-gray-500 ml-2">Lower numbers appear first</span>
    </div>
  </div>
</template>

<template id="download-link-template">
  <div class="download-link-fields border border-gray-200 rounded-lg p-4 mb-4">
    <input type="hidden" name="game[download_links_attributes][INDEX_PLACEHOLDER][id]" value="">

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Label</label>
        <input type="text"
               name="game[download_links_attributes][INDEX_PLACEHOLDER][label]"
               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
               placeholder="e.g., Windows Download, Mac Version">
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">URL</label>
        <input type="url"
               name="game[download_links_attributes][INDEX_PLACEHOLDER][url]"
               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
               placeholder="https://...">
      </div>
    </div>

    <div class="mb-4">
      <label class="block text-sm font-medium text-gray-700 mb-2">Platforms</label>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
        <% @platforms.each do |platform| %>
          <label class="flex items-center">
            <input type="checkbox"
                   name="game[download_links_attributes][INDEX_PLACEHOLDER][platform_ids][]"
                   value="<%= platform.id %>"
                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
            <span class="ml-2 text-sm text-gray-700"><%= platform.name %></span>
          </label>
        <% end %>
      </div>
    </div>

    <button type="button"
            onclick="this.closest('.download-link-fields').remove()"
            class="text-red-600 hover:text-red-800 text-sm font-medium">
      Remove Download Link
    </button>
  </div>
</template>

<script>
  let downloadLinkIndex = <%= @game.download_links.size %>;
  let mediaIndex = <%= @game.media.size %>;

  function addDownloadLink() {
    const container = document.getElementById('download-links');
    const template = document.getElementById('download-link-template');
    const clone = template.content.cloneNode(true);
    
    // Replace all instances of INDEX_PLACEHOLDER with the current index
    const html = clone.querySelector('.download-link-fields').outerHTML;
    const updatedHtml = html.replace(/INDEX_PLACEHOLDER/g, downloadLinkIndex);
    
    container.insertAdjacentHTML('beforeend', updatedHtml);
    downloadLinkIndex++;
  }

  function addMediaField(mediaType) {
    // Check current count limits
    const existingScreenshots = document.querySelectorAll('input[name*="[media_type]"][value="screenshot"]').length;
    const existingVideos = document.querySelectorAll('input[name*="[media_type]"][value="video"]').length;
    
    if (mediaType === 'screenshot' && existingScreenshots >= 6) {
      alert('Maximum 6 screenshots allowed');
      return;
    }
    
    if (mediaType === 'video' && existingVideos >= 3) {
      alert('Maximum 3 videos allowed');
      return;
    }

    const container = document.getElementById('existing-media');
    const template = document.getElementById('media-field-template');
    const clone = template.content.cloneNode(true);
    
    // Replace placeholders with actual values
    let html = clone.querySelector('.media-field').outerHTML;
    html = html.replace(/MEDIA_INDEX_PLACEHOLDER/g, mediaIndex);
    html = html.replace(/MEDIA_TYPE_PLACEHOLDER/g, mediaType);
    html = html.replace(/MEDIA_TYPE_LABEL_PLACEHOLDER/g, mediaType.charAt(0).toUpperCase() + mediaType.slice(1));
    
    // Set the correct file input accept attribute
    if (mediaType === 'screenshot') {
      html = html.replace(/ACCEPT_PLACEHOLDER/g, 'image/jpeg,image/jpg,image/png,image/gif,image/webp');
      html = html.replace(/FILE_CLASS_PLACEHOLDER/g, 'block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500');
    } else {
      html = html.replace(/ACCEPT_PLACEHOLDER/g, 'video/mp4,video/webm,video/ogg,video/avi,video/mov');
      html = html.replace(/FILE_CLASS_PLACEHOLDER/g, 'block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500');
    }
    
    container.insertAdjacentHTML('beforeend', html);
    mediaIndex++;
  }

  function removeMediaField(button) {
    const mediaField = button.closest('.media-field');
    const destroyField = mediaField.querySelector('.destroy-field');
    
    if (destroyField) {
      // Mark for destruction instead of removing
      destroyField.value = 'true';
      mediaField.style.display = 'none';
    } else {
      // Remove new field completely
      mediaField.remove();
    }
    
    // Notify drag-drop controllers to update counters
    document.querySelectorAll('[data-controller*="drag-drop-upload"]').forEach(controller => {
      const stimulusController = controller.stimulus?.controllers?.find(c => c.identifier === 'drag-drop-upload');
      if (stimulusController) {
        stimulusController.mediaFieldRemoved();
      }
    });
  }

  // Cover image selection functions
  function selectCoverImage(screenshotId, element) {
    // Update hidden field
    document.getElementById('cover_image_id_field').value = screenshotId;
    
    // Update visual selection
    document.querySelectorAll('.cover-option').forEach(option => {
      option.classList.remove('border-blue-500', 'ring-2', 'ring-blue-200');
      option.classList.add('border-gray-200');
      option.querySelector('.cover-selected-indicator').classList.add('opacity-0');
      option.querySelector('.cover-selected-indicator').classList.remove('opacity-100');
    });
    
    element.classList.remove('border-gray-200');
    element.classList.add('border-blue-500', 'ring-2', 'ring-blue-200');
    element.querySelector('.cover-selected-indicator').classList.remove('opacity-0');
    element.querySelector('.cover-selected-indicator').classList.add('opacity-100');
    
    // Show clear button
    document.getElementById('clear-cover-button').classList.remove('hidden');
  }
  
  function clearCoverImage() {
    // Clear hidden field
    document.getElementById('cover_image_id_field').value = '';
    
    // Clear visual selection
    document.querySelectorAll('.cover-option').forEach(option => {
      option.classList.remove('border-blue-500', 'ring-2', 'ring-blue-200');
      option.classList.add('border-gray-200');
      option.querySelector('.cover-selected-indicator').classList.add('opacity-0');
      option.querySelector('.cover-selected-indicator').classList.remove('opacity-100');
    });
    
    // Hide clear button
    document.getElementById('clear-cover-button').classList.add('hidden');
  }
  
  function addCoverImageOption(screenshotId, previewUrl, title) {
    const container = document.getElementById('cover-image-options');
    const noScreenshotsMessage = document.getElementById('no-screenshots-message');
    
    // Hide no screenshots message
    if (noScreenshotsMessage) {
      noScreenshotsMessage.classList.add('hidden');
    }
    
    // Create new cover option
    const optionHtml = `
      <div class="cover-option relative cursor-pointer border-2 border-gray-200 hover:border-blue-300 rounded-lg overflow-hidden transition-all duration-200"
           onclick="selectCoverImage(${screenshotId}, this)">
        <img src="${previewUrl}" class="w-full h-24 object-cover" alt="${title}">
        
        <div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-20 transition-all duration-200 flex items-center justify-center">
          <div class="cover-selected-indicator opacity-0 transition-opacity duration-200">
            <div class="bg-blue-500 text-white rounded-full p-1">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
            </div>
          </div>
        </div>
        
        <div class="absolute bottom-1 left-1 right-1">
          <div class="bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded text-center truncate">
            ${title}
          </div>
        </div>
      </div>
    `;
    
    container.insertAdjacentHTML('beforeend', optionHtml);
    
    // Auto-select as cover image if it's the first screenshot
    const existingOptions = container.querySelectorAll('.cover-option').length;
    const currentCoverImage = document.getElementById('cover_image_id_field').value;
    
    if (existingOptions === 1 && !currentCoverImage) {
      const newOption = container.lastElementChild;
      selectCoverImage(screenshotId, newOption);
    }
  }

  // Initialize media index from existing media count
  document.addEventListener('DOMContentLoaded', function() {
    const existingMediaCount = document.querySelectorAll('#existing-media .media-field').length;
    document.body.dataset.mediaIndex = existingMediaCount;
  });
</script>