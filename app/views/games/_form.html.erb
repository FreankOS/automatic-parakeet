<%= form_with model: @game, local: true, multipart: true, class: "space-y-6" do |form| %>
  <% if @game.errors.any? %>
    <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
      <h4 class="font-medium mb-2"><%= pluralize(@game.errors.count, "error") %> prohibited this game from being saved:</h4>
      <ul class="list-disc list-inside space-y-1">
        <% @game.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <!-- Game Name -->
  <div>
    <%= form.label :name, class: "block text-sm font-medium text-gray-700 mb-2" %>
    <%= form.text_field :name,
        class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",
        placeholder: "Enter your game's name" %>
  </div>

  <!-- Description -->
  <div>
    <%= form.label :description, class: "block text-sm font-medium text-gray-700 mb-2" %>
    <%= form.text_area :description,
        rows: 6,
        class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",
        placeholder: "Describe your game, its features, gameplay, and what makes it special..." %>
  </div>

  <!-- Genre and Tool -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div>
      <%= form.label :genre_id, "Genre", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.select :genre_id,
          options_from_collection_for_select(@genres, :id, :translated_name, @game.genre_id),
          { prompt: "Select a genre" },
          { class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" } %>
    </div>

    <div>
      <%= form.label :tool_id, "Development Tool", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.select :tool_id,
          options_from_collection_for_select(@tools, :id, :name, @game.tool_id),
          { prompt: "Select development tool" },
          { class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" } %>
    </div>
  </div>

  <!-- Release Type and Adult Content -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div>
      <%= form.label :release_type, class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.select :release_type,
          options_for_select([
            ["Complete Game", "complete"],
            ["Demo", "demo"],
            ["Mini Game", "minigame"]
          ], @game.release_type),
          { prompt: "Select release type" },
          { class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" } %>
    </div>

    <div class="flex items-center pt-8">
      <%= form.check_box :adult_content,
          class: "h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" %>
      <%= form.label :adult_content, "Adult Content", class: "ml-2 text-sm font-medium text-gray-700" %>
    </div>
  </div>

  <!-- Media Uploads -->
  <div>
    <h3 class="text-lg font-medium text-gray-900 mb-4">Media</h3>
    
    <!-- Existing Media -->
    <div id="existing-media" class="mb-6">
      <%= form.fields_for :media do |media_form| %>
        <%= render 'media_fields', form: media_form %>
      <% end %>
    </div>

    <!-- Add New Media Buttons -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <button type="button"
              onclick="addMediaField('screenshot')"
              class="inline-flex items-center justify-center px-4 py-3 border border-blue-300 rounded-lg text-sm font-medium text-blue-700 bg-blue-50 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
        <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
        </svg>
        Add Screenshot
        <span class="ml-2 text-xs">(Max 6)</span>
      </button>

      <button type="button"
              onclick="addMediaField('video')"
              class="inline-flex items-center justify-center px-4 py-3 border border-purple-300 rounded-lg text-sm font-medium text-purple-700 bg-purple-50 hover:bg-purple-100 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-colors">
        <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
        </svg>
        Add Video
        <span class="ml-2 text-xs">(Max 3)</span>
      </button>
    </div>

    <!-- Media Upload Guidelines -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
      <h4 class="text-sm font-medium text-blue-900 mb-2">Media Guidelines</h4>
      <ul class="text-sm text-blue-800 space-y-1 list-disc list-inside">
        <li>Screenshots should showcase your game's best features and gameplay</li>
        <li>Videos can include gameplay footage, trailers, or tutorials</li>
        <li>Keep file sizes reasonable for faster loading (Screenshots: 10MB max, Videos: 100MB max)</li>
        <li>Media will be displayed in the order you upload them</li>
      </ul>
    </div>
  </div>

  <!-- Download Links -->
  <div>
    <h3 class="text-lg font-medium text-gray-900 mb-4">Download Links</h3>
    <div id="download-links">
      <%= form.fields_for :download_links do |link_form| %>
        <%= render 'download_link_fields', form: link_form, platforms: @platforms %>
      <% end %>
    </div>

    <button type="button"
            onclick="addDownloadLink()"
            class="mt-4 inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
      <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
      </svg>
      Add Download Link
    </button>
  </div>

  <!-- Submit Buttons -->
  <div class="flex items-center justify-between pt-6 border-t border-gray-200">
    <%= link_to cancel_path,
        class: "px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium transition-colors" do %>
      Cancel
    <% end %>

    <%= form.submit submit_text,
        class: "px-6 py-2 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white rounded-lg font-medium transition-all duration-200 shadow-sm" %>
  </div>
<% end %>

<template id="media-field-template">
  <div class="media-field border border-gray-200 rounded-lg p-4 mb-4">
    <input type="hidden" name="game[media_attributes][MEDIA_INDEX_PLACEHOLDER][media_type]" value="MEDIA_TYPE_PLACEHOLDER">
    
    <div class="flex items-start justify-between mb-4">
      <div class="flex-1">
        <h4 class="text-sm font-medium text-gray-900 mb-2">
          <span class="media-type-label">MEDIA_TYPE_LABEL_PLACEHOLDER</span>
          <span class="text-xs text-gray-500">(New)</span>
        </h4>
      </div>
      
      <button type="button" 
              onclick="removeMediaField(this)"
              class="text-red-600 hover:text-red-800 text-sm font-medium ml-4">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
        </svg>
      </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <!-- File Upload -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">File</label>
        <input type="file"
               name="game[media_attributes][MEDIA_INDEX_PLACEHOLDER][file]"
               accept="ACCEPT_PLACEHOLDER"
               class="FILE_CLASS_PLACEHOLDER">
      </div>

      <!-- Title -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Title (Optional)</label>
        <input type="text"
               name="game[media_attributes][MEDIA_INDEX_PLACEHOLDER][title]"
               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
               placeholder="e.g., Main Menu, Gameplay Screenshot">
      </div>
    </div>

    <!-- Description -->
    <div class="mb-4">
      <label class="block text-sm font-medium text-gray-700 mb-2">Description (Optional)</label>
      <textarea name="game[media_attributes][MEDIA_INDEX_PLACEHOLDER][description]"
                rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="Brief description of this media..."></textarea>
    </div>

    <!-- Position -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Display Order</label>
      <input type="number"
             name="game[media_attributes][MEDIA_INDEX_PLACEHOLDER][position]"
             class="w-20 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
             min="0"
             placeholder="0">
      <span class="text-xs text-gray-500 ml-2">Lower numbers appear first</span>
    </div>
  </div>
</template>

<template id="download-link-template">
  <div class="download-link-fields border border-gray-200 rounded-lg p-4 mb-4">
    <input type="hidden" name="game[download_links_attributes][INDEX_PLACEHOLDER][id]" value="">

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Label</label>
        <input type="text"
               name="game[download_links_attributes][INDEX_PLACEHOLDER][label]"
               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
               placeholder="e.g., Windows Download, Mac Version">
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">URL</label>
        <input type="url"
               name="game[download_links_attributes][INDEX_PLACEHOLDER][url]"
               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
               placeholder="https://...">
      </div>
    </div>

    <div class="mb-4">
      <label class="block text-sm font-medium text-gray-700 mb-2">Platforms</label>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
        <% @platforms.each do |platform| %>
          <label class="flex items-center">
            <input type="checkbox"
                   name="game[download_links_attributes][INDEX_PLACEHOLDER][platform_ids][]"
                   value="<%= platform.id %>"
                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
            <span class="ml-2 text-sm text-gray-700"><%= platform.name %></span>
          </label>
        <% end %>
      </div>
    </div>

    <button type="button"
            onclick="this.closest('.download-link-fields').remove()"
            class="text-red-600 hover:text-red-800 text-sm font-medium">
      Remove Download Link
    </button>
  </div>
</template>

<script>
  let downloadLinkIndex = <%= @game.download_links.size %>;
  let mediaIndex = <%= @game.media.size %>;

  function addDownloadLink() {
    const container = document.getElementById('download-links');
    const template = document.getElementById('download-link-template');
    const clone = template.content.cloneNode(true);
    
    // Replace all instances of INDEX_PLACEHOLDER with the current index
    const html = clone.querySelector('.download-link-fields').outerHTML;
    const updatedHtml = html.replace(/INDEX_PLACEHOLDER/g, downloadLinkIndex);
    
    container.insertAdjacentHTML('beforeend', updatedHtml);
    downloadLinkIndex++;
  }

  function addMediaField(mediaType) {
    // Check current count limits
    const existingScreenshots = document.querySelectorAll('input[name*="[media_type]"][value="screenshot"]').length;
    const existingVideos = document.querySelectorAll('input[name*="[media_type]"][value="video"]').length;
    
    if (mediaType === 'screenshot' && existingScreenshots >= 6) {
      alert('Maximum 6 screenshots allowed');
      return;
    }
    
    if (mediaType === 'video' && existingVideos >= 3) {
      alert('Maximum 3 videos allowed');
      return;
    }

    const container = document.getElementById('existing-media');
    const template = document.getElementById('media-field-template');
    const clone = template.content.cloneNode(true);
    
    // Replace placeholders with actual values
    let html = clone.querySelector('.media-field').outerHTML;
    html = html.replace(/MEDIA_INDEX_PLACEHOLDER/g, mediaIndex);
    html = html.replace(/MEDIA_TYPE_PLACEHOLDER/g, mediaType);
    html = html.replace(/MEDIA_TYPE_LABEL_PLACEHOLDER/g, mediaType.charAt(0).toUpperCase() + mediaType.slice(1));
    
    // Set the correct file input accept attribute
    if (mediaType === 'screenshot') {
      html = html.replace(/ACCEPT_PLACEHOLDER/g, 'image/jpeg,image/jpg,image/png,image/gif,image/webp');
      html = html.replace(/FILE_CLASS_PLACEHOLDER/g, 'block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500');
    } else {
      html = html.replace(/ACCEPT_PLACEHOLDER/g, 'video/mp4,video/webm,video/ogg,video/avi,video/mov');
      html = html.replace(/FILE_CLASS_PLACEHOLDER/g, 'block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500');
    }
    
    container.insertAdjacentHTML('beforeend', html);
    mediaIndex++;
  }

  function removeMediaField(button) {
    const mediaField = button.closest('.media-field');
    const destroyField = mediaField.querySelector('.destroy-field');
    
    if (destroyField) {
      // Mark for destruction instead of removing
      destroyField.value = 'true';
      mediaField.style.display = 'none';
    } else {
      // Remove new field completely
      mediaField.remove();
    }
  }
</script>