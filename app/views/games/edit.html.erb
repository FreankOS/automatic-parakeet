<% content_for :title, "Edit #{@game.name}" %>

<div class="container mx-auto px-4 max-w-4xl">
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
    <div class="mb-6">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">Edit Game</h1>
      <p class="text-gray-600">Update your game information</p>
    </div>

    <%= form_with model: @game, local: true, multipart: true, class: "space-y-6" do |form| %>
      <% if @game.errors.any? %>
        <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
          <h4 class="font-medium mb-2"><%= pluralize(@game.errors.count, "error") %> prohibited this game from being saved:</h4>
          <ul class="list-disc list-inside space-y-1">
            <% @game.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <!-- Game Name -->
      <div>
        <%= form.label :name, class: "block text-sm font-medium text-gray-700 mb-2" %>
        <%= form.text_field :name,
            class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",
            placeholder: "Enter your game's name" %>
      </div>

      <!-- Description -->
      <div>
        <%= form.label :description, class: "block text-sm font-medium text-gray-700 mb-2" %>
        <%= form.text_area :description,
            rows: 6,
            class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",
            placeholder: "Describe your game, its features, gameplay, and what makes it special..." %>
      </div>

      <!-- Genre and Tool -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <%= form.label :genre_id, "Genre", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= form.select :genre_id,
              options_from_collection_for_select(@genres, :id, :translated_name, @game.genre_id),
              { prompt: "Select a genre" },
              { class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" } %>
        </div>

        <div>
          <%= form.label :tool_id, "Development Tool", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= form.select :tool_id,
              options_from_collection_for_select(@tools, :id, :name, @game.tool_id),
              { prompt: "Select development tool" },
              { class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" } %>
        </div>
      </div>

      <!-- Release Type and Adult Content -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <%= form.label :release_type, class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= form.select :release_type,
              options_for_select([
                ["Complete Game", "complete"],
                ["Demo", "demo"],
                ["Mini Game", "minigame"]
              ], @game.release_type),
              { prompt: "Select release type" },
              { class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" } %>
        </div>

        <div class="flex items-center pt-8">
          <%= form.check_box :adult_content,
              class: "h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" %>
          <%= form.label :adult_content, "Adult Content", class: "ml-2 text-sm font-medium text-gray-700" %>
        </div>
      </div>

      <!-- Download Links -->
      <div>
        <h3 class="text-lg font-medium text-gray-900 mb-4">Download Links</h3>
        <div id="download-links">
          <%= form.fields_for :download_links do |link_form| %>
            <%= render 'download_link_fields', form: link_form, platforms: @platforms %>
          <% end %>
        </div>

        <button type="button"
                onclick="addDownloadLink()"
                class="mt-4 inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
          <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
          </svg>
          Add Download Link
        </button>
      </div>

      <!-- Submit Buttons -->
      <div class="flex items-center justify-between pt-6 border-t border-gray-200">
        <%= link_to "Cancel", @game,
            class: "px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium transition-colors" %>

        <%= form.submit "Update Game",
            class: "px-6 py-2 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white rounded-lg font-medium transition-all duration-200 shadow-sm" %>
      </div>
    <% end %>
  </div>
</div>

<script>
  let downloadLinkIndex = <%= @game.download_links.size %>;

  function addDownloadLink() {
    const container = document.getElementById('download-links');
    const template = `
      <div class="download-link-fields border border-gray-200 rounded-lg p-4 mb-4">
        <input type="hidden" name="game[download_links_attributes][${downloadLinkIndex}][id]" value="">

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Label</label>
            <input type="text"
                   name="game[download_links_attributes][${downloadLinkIndex}][label]"
                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                   placeholder="e.g., Windows Download, Mac Version">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">URL</label>
            <input type="url"
                   name="game[download_links_attributes][${downloadLinkIndex}][url]"
                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                   placeholder="https://...">
          </div>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Platforms</label>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
            <% @platforms.each do |platform| %>
              <label class="flex items-center">
                <input type="checkbox"
                       name="game[download_links_attributes][${downloadLinkIndex}][platform_ids][]"
                       value="<%= platform.id %>"
                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                <span class="ml-2 text-sm text-gray-700"><%= platform.name %></span>
              </label>
            <% end %>
          </div>
        </div>

        <button type="button"
                onclick="this.closest('.download-link-fields').remove()"
                class="text-red-600 hover:text-red-800 text-sm font-medium">
          Remove Download Link
        </button>
      </div>
    `;

    container.insertAdjacentHTML('beforeend', template);
    downloadLinkIndex++;
  }
</script>